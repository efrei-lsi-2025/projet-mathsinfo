<html>
  <head>
    <title>Itinéraire RATP - Projet Maths Info</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      .itineraire {
        display: flex;
        flex-direction: row;
        gap: 30px;
      }

      @media screen and (max-width: 700px) {
        .itineraire {
          flex-direction: column-reverse;
        }
      }

      .itineraire form {
        flex: 0.4;
        width: 100%;
      }

      .itineraire .map {
        position: relative;
      }

      .itineraire svg {
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0.8;
        width: 100%;
        height: 100%;
      }

      .itineraire .map, .map img {
        border-radius: 10px;
        flex: 0.7;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Itinéraire RATP - Projet Maths Info</h1>
      <div class="itineraire">
        <form>
          <label for="start">Départ</label>
          <select id="start" v-model="start">
            <option v-for="station in stations" :value="station.num">
              {{ station.num }} - {{ station.nom }} (Ligne {{ station.ligne }})
            </option>
          </select>
          <label for="end">Arrivée</label>
          <select id="end" v-model="end">
            <option v-for="station in stations" :value="station.num">
              {{ station.num }} - {{ station.nom }} (Ligne {{ station.ligne }})
            </option>
          </select>
          <button type="button" @click="search">Rechercher</button>
          <p>
            <strong>Temps estimé:</strong> {{ timeString }} minutes ({{ time }}s)
            <p v-for="station in path" :key="station.num">
              <img :src="`/icons/${station.ligne}.png`" style="width: 24px; height: 24px;"> {{ station.nom }} ({{ station.num }}) {{ getTimeAdded(station) ? '(+' + getTimeAdded(station) + 's)' : '' }}
            </p>
          </p>
        </form>
        <div class="map">
          <img :src="map" />
          <svg width="987" height="952" viewBox="18 0 950 952">
            <g v-for="station in stations" :key="station.num">
              <circle
                :cx="station.lat"
                :cy="station.lng"
                r="3"
                stroke="black"
                stroke-width="1"
                fill="white"
                @click="selectStation(station)"
              />
            </g>
          </svg>
        </div>
      </div>
    </main>
  </body>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          stations: [],
          start: null,
          end: null,
          map: "/api/canvas",
          path: [],
          time: null
        };
      },
      mounted() {
        this.getStations();
      },
      methods: {
        selectStation(station) {
          if (this.start === null) {
            this.start = station.num;
          } else if (this.end === null) {
            this.end = station.num;
            this.search();
          } else {
            this.start = station.num;
            this.end = null;
          }
        },
        async getStations() {
          const response = await fetch("api/stations");
          const data = await response.json();
          this.stations = data;
        },
        async search() {
          const response = await fetch("api/path/" + this.start + "/" + this.end);
          const data = await response.json();
          this.map = data.canvas;
          this.time = data.time;
          this.path = data.path;
        },
        formatTime(time) {
          const h = Math.floor(time / 3600).toString().padStart(2,'0'),
                  m = Math.floor(time % 3600 / 60).toString().padStart(2,'0'),
                  s = Math.floor(time % 60).toString().padStart(2,'0');
            
          return `${h}:${m}:${s}`;
        },
        getTimeAdded(station) {
          if(station.num == this.start) return;
          for(let stn in this.path) {
            for(let adj of this.path[stn].adjacentStations) {
              if(adj.num === station.num) {
                return adj.correspondance;
              }
            }
          }
        }
      },
      computed: {
        timeString() {
          return this.formatTime(this.time);
        }
      }
    }).mount("main");
  </script>
</html>
